#!/usr/bin/env bash
set -euo pipefail

# Check for required commands
if ! command -v fzf &>/dev/null || ! command -v tmux &>/dev/null || ! command -v fd &>/dev/null; then
    echo "Error: fzf, tmux, or fd is not installed."
    exit 1
fi

search_dirs=(
    ~/personal
    ~/work
    ~/work/gm/apps
    ~/work/gm/libs
    ~/work/fulus-africa/packages
    ~/work/fulus-africa/shared
    ~/lab
)

selected=""
if [[ $# -eq 1 ]]; then
    selected="$1"
    if [[ ! -d "$selected" ]]; then
        echo "Error: Directory '$selected' does not exist."
        exit 1
    fi
else
    selected=$(fd --type d --hidden --follow --max-depth 1 . "${search_dirs[@]}" | fzf)
fi

if [[ -z "$selected" ]]; then
    exit 0
fi

selected_name=$(basename "$selected" | tr . _)

# This is the core logic. It will handle all cases.
if ! tmux has-session -t="$selected_name" 2>/dev/null; then
    # The session does not exist, so create it in a detached state.
    tmux new-session -ds "$selected_name" -c "$selected"
fi

# Now, attach to or switch to the session.
if [[ -z "${TMUX:-}" ]]; then
    # Not in a tmux session, so we can safely attach.
    tmux attach-session -t "$selected_name"
else
    # Already in a tmux session, so we must switch clients to avoid nesting.
    tmux switch-client -t "$selected_name"
fi
