#!/usr/bin/env bash
set -euo pipefail

for cmd in fzf mpc fd bat yt-dlp; do
    command -v "$cmd" >/dev/null 2>&1 || { echo "Error: $cmd is not installed."; exit 1; }
done

MPD_MUSIC_DIR="$HOME/play/music"

play_playlist() {
    local playlists
    playlists=$(mpc ls "" | grep -v '/$' | sed 's|/$||' | sort -u)
    [[ -z "$playlists" ]] && { echo "No playlists found."; return; }

    local selection
    selection=$(echo "$playlists" | fzf --prompt="Select Playlist> ")
    [[ -z "$selection" ]] && return

    mpc clear
    mpc add "$selection"
    mpc play
}

play_song() {
    local song_file
    song_file=$(fd --type f . "$MPD_MUSIC_DIR" | fzf --prompt="Select Song> " --preview 'bat --color=always {}' --preview-window 'right:60%')
    [[ -z "$song_file" ]] && return

    local relative_path="${song_file#$MPD_MUSIC_DIR/}"
    mpc clear
    mpc add "$relative_path"
    mpc play
}

add_to_queue() {
    local song_file
    song_file=$(fd --type f . "$MPD_MUSIC_DIR" | fzf --prompt="Add to Queue> " --preview 'bat --color=always {}' --preview-window 'right:60%')
    [[ -z "$song_file" ]] && return

    local relative_path="${song_file#$MPD_MUSIC_DIR/}"
    mpc add "$relative_path"
    echo "Added to queue: $relative_path"
}

show_queue() {
    mpc playlist | fzf --prompt="Current Queue> " --preview "mpc play {1}" --preview-window 'right:50%'
}

play_yt_stream() {
    local url
    read -rp "Enter YouTube URL: " url
    [[ -z "$url" ]] && return

    local stream_url
    stream_url=$(yt-dlp -f bestaudio -g "$url")

    mpc clear
    mpc add "$stream_url"
    mpc play
}

playback_controls() {
    while true; do
        local action
        action=$(printf "%s\n" \
            "Play/Pause" \
            "Stop" \
            "Next" \
            "Previous" \
            "Clear Playlist" \
            "Shuffle" \
            "Volume Up" \
            "Volume Down" \
            "Set Volume" \
            "Toggle Repeat" \
            "Toggle Random" \
            "Back to Main Menu" | fzf --prompt="Playback Controls> ")

        case "$action" in
            "Play/Pause") mpc toggle ;;
            "Stop") mpc stop ;;
            "Next") mpc next ;;
            "Previous") mpc prev ;;
            "Clear Playlist") mpc clear ;;
            "Shuffle") mpc shuffle ;;
            "Volume Up") mpc volume +5 ;;
            "Volume Down") mpc volume -5 ;;
            "Set Volume")
                read -rp "Enter volume (0-100): " vol
                [[ "$vol" =~ ^[0-9]{1,3}$ ]] && mpc volume "$vol"
                ;;
            "Toggle Repeat") mpc repeat ;;
            "Toggle Random") mpc random ;;
            "Back to Main Menu" | "") return ;;
        esac
    done
}

main_menu() {
    while true; do
        local choice
        choice=$(printf "%s\n" \
            "Play a Playlist" \
            "Play a Specific Song" \
            "Add Song to Queue" \
            "Play YouTube Stream" \
            "Show Current Queue" \
            "Playback Controls" \
            "Exit" | fzf --prompt="Music Menu> ")

        case "$choice" in
            "Play a Playlist") play_playlist ;;
            "Play a Specific Song") play_song ;;
            "Add Song to Queue") add_to_queue ;;
            "Play YouTube Stream") play_yt_stream ;;
            "Show Current Queue") show_queue ;;
            "Playback Controls") playback_controls ;;
            "Exit" | "") echo "Goodbye!"; exit 0 ;;
        esac
    done
}

main_menu
